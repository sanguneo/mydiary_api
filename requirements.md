# 일기 앱 서비스 소개 및 요구사항 (요약)

**프로젝트:** Private Emotion Diary  
**작성일:** 2025-10-28

---

## 개요 / 서비스 소개
본 서비스는 SNS형 공유 기능이 없는, 개인의 심리·감정·일상을 기록하는 모바일 일기 애플리케이션입니다.  
아날로그 느낌(줄노트, 원고지 등)을 살린 UI 제공을 목표로 하며, 사용자는 언제든지 자유롭게 생각이나 감정을 정리하여 기록할 수 있습니다.  
기본 철학은 **"나의 감정과 일상을 안전하게, 방해받지 않고 기록"** 하는 것에 있습니다.

---

## 핵심 가치
- **프라이버시 우선**: 내용은 기본적으로 암호화되어 저장되며, 평문은 서버에 저장되지 않도록 설계(클라이언트 사이드 암호화 옵션 제공).
- **심리적 안전감**: 작성 중에는 방해 요소를 최소화(음악 허용, 그 외 알림·공유 권장하지 않음).
- **단순성**: 작성화면은 1 depth(단일 화면)로 설계, 읽기/목록은 2 depth로 간단히 접근.
- **회고 기능**: 달력과 대시보드를 통해 과거(작년, 재작년 등)의 동일한 '월/주/일' 기록을 비교하여 회고 가능.

---

## 목표 (MVP 범위)
1. 사용자 인증(가입/로그인/로그아웃/토큰 리프레시) — Supabase Auth 사용.  
2. 암호화된 일기 저장(본문은 ciphertext로 저장). 사용자는 언제든지 작성 가능.  
3. 일기 **잠금 기능**: 각 항목별로 잠금 가능(잠긴 일기는 목록과 날짜 정보는 보이나 본문 열람 시 계정 비밀번호 입력 필요).  
4. 감정 태그 추가 및 감정별/태그별 필터(검색은 날짜 기준만; 내용 전체 검색은 미포함).  
5. 달력 뷰 + 대시보드(오늘의 날씨/미세먼지/날짜 표시 포함) — 과거(작년·재작년) 기록은 해당 날짜 기준과 *x월 y째주 z일* 기준으로 비교.  
6. 템플릿 기능: "질문 받아보기" 등 작성 가이드 템플릿 제공.  
7. 관리자 기능(기본): 사용자 목록 조회, 사용자 정지/복구, 감사 로그(audit_logs)에 관리자 행동 기록.  
8. Postman 컬렉션 및 DB 마이그레이션 SQL 포함(프로젝트 루트).

---

## 기능적 요구사항 (상세)

### 사용자(프런트엔드 관점)
- **가입 / 로그인 / 로그아웃 / 토큰 리프레시** 엔드포인트(프록시 제공 가능). 인증은 Supabase Auth 사용.
- **일기 작성 화면(1 depth)**
  - 다양한 레이아웃(줄노트, 원고지 등) 제공.
  - 작성 중엔 음악 재생만 허용(권장 안내만 제공, 강제 아님).
  - 작성 시 클라이언트가 AES-GCM으로 본문 암호화(옵션: E2E 암호화).
  - 작성 메타: 날짜, 시간, 감정 태그(이모지 포함), 사용자 태그 배열.
  - 저장 시 서버에 `ciphertext`, `iv`, `wrapped_entry_key`, `meta` 전송.
- **보기 화면(2 depth)**
  - 같은 날짜에 작성된 항목 목록(시간순) + 헤드라인(미리보기) 제공.
  - 잠긴 항목은 본문 미노출, 열람 시 계정 비밀번호 확인 요구.
- **검색/필터**
  - 날짜 검색(기본) — 달력에서 날짜 클릭.
  - 감정/태그 필터 — `meta` 필드 기반.
  - 내용 기반 전체 텍스트 검색은 제공하지 않음(프라이버시·암호화 설계).
- **대시보드**
  - 상단: 오늘의 날짜, 날씨 정보, 미세먼지(옵션 외부 API).
  - 달력: 작성 여부 표시(잠긴 항목 존재 시 표시 유지).
  - 회고패널: 작년/재작년 동일한 월·주·일 기준의 항목(있을 때만 표시).

### 서버(백엔드 관점)
- **기술스택**: Bun + Hono (서버), Supabase (Postgres + Auth).
- **주요 엔드포인트(요약)**
  - `POST /api/auth/login`, `POST /api/auth/logout`, `POST /api/auth/refresh`, `GET /api/auth/user` (서버 프록시 혹은 프런트엔드 직접 사용 권장)
  - `POST /api/init` (프로필 초기화, account_key 생성/랩핑 메타 저장)
  - `GET /api/entries?date=YYYY-MM-DD` (metadata 리스트)
  - `POST /api/entries` (암호문 저장)
  - `GET /api/entries/:id` (ciphertext + wrapped_entry_key 등 반환)
  - `POST /api/keys/wrap` (서버측 래핑 도우미; 현재는 `SERVER_WRAP_KEY` 기반)
  - Admin: `GET /api/admin/users`, `POST /api/admin/users/:id/suspend`, `POST /api/admin/request-unwrap`
- **데이터베이스(요약)**
  - `profiles` (auth.users.id 참조, account_key_meta, settings, is_disabled)
  - `entries` (id, user_id, entry_date, entry_time, is_locked, ciphertext, iv, wrapped_entry_key, meta)
  - `admin_roles`, `audit_logs`
  - RLS(행 수준 보안) 정책으로 사용자가 자신의 데이터만 접근 가능하도록 설정
- **암호화/키 관리**
  - 계정 생성 시 고유 값(nanoid 기반)으로 account master key 생성(서버에서 래핑하여 `account_key_meta`로 저장).
  - 일기 암호화는 클라이언트에서 AES-GCM으로 수행(입력: `entry_key`). `entry_key`는 클라이언트가 생성하고 서버에 래핑된 형태로 저장.
  - 잠긴 항목 열람 시 사용자 인증(계정 비밀번호) 확인 후, 클라이언트가 `wrapped_entry_key`를 서버로부터 받아 복호화 가능하도록 처리(unwrap은 서버에서 래핑키로 수행하거나 클라이언트 로컬에서 복호화 수행).
  - 현재 KMS 미사용: 개발/초기 운영은 `SERVER_WRAP_KEY` 환경변수로 래핑 수행. 프로덕션에서는 안전한 비밀저장소 권장(환경 변수 관리는 Codex 환경 사용).
- **감사/보안**
  - 관리자 액션(정지, 언래핑 요청 등)은 `audit_logs`에 기록(actor_id, target_user_id, action, details, timestamp).
  - 관리자 권한은 `admin_roles` 테이블로 관리.
  - 서비스는 서비스 키(`SUPABASE_SERVICE_KEY`)를 서버에서만 사용. 절대 클라이언트 노출 금지.

---

## 비기능적 요구사항
- **프라이버시**: 평문 저장을 지양. 기본 동작은 ciphertext 저장.
- **확장성**: 가벼운 API 설계(Bun+Hono)로 모바일 트래픽 처리를 목표.
- **운영**: Postman 컬렉션, DB 마이그레이션 SQL 포함. 로그·감사 추적 필수.
- **로컬/개발 환경**: Codex(혹은 로컬 .env) 환경변수 사용. `SERVER_WRAP_KEY`는 개발 전용(프로덕션에선 대체 권장).

---

## 제약 및 제외 항목
- SNS 형식의 공유·공개 기능은 제외.
- 본 MVP에서는 전문적 위기 대응 메시지(안전 문구/위기 리소스)는 제외.
- 내용 기반 전체 텍스트 검색은 제공하지 않음(암호화·프라이버시 고려).

---

## 다음 단계(권장)
1. 본 요구사항 확인 및 우선순위 확정(핵심: 인증, 일기 암호화 저장, 잠금/열람 흐름).  
2. API 스펙 확정 → Postman 컬렉션 생성 → DB 마이그레이션 적용.  
3. 클라이언트 암호화 라이브러리 예제(AES-GCM 사용법) 및 계정 키 생성 흐름 제공.  
4. 관리자 언래핑 워크플로우 및 감사 프로세스 문서화.

---

**작성자:** 팀 (요구사항 요약)  
**참고:** 이 문서는 기획(요구사항) 요약입니다. 설계(아키텍처·DB 스키마·API 상세)는 확인 후 별도 문서로 전환하세요.
